#!/usr/bin/env ruby
# vim: set fileencoding=utf-8 :
$VERBOSE = true

require 'optparse'
require 'rubygems'
require 'mechanize'

opt = OptionParser.new( "#{$PROGRAM_NAME}: [options...] [http://atnd.org/events/]EVENT_ID")
opts = {}
opts[:list_name] = nil
opts[:evt_service] = :atnd
begin
  opt.on('-l', '--list-name=LIST_NAME', 'The name of twitter list to create or to add.'){|v| opts[:list_name] = v }
  opt.on('-a', '--atend', 'The event page is of atnd.org'){ opts[:evt_service] = :atnd }
  opt.order!(ARGV)
rescue OptionParser::ParseError
  fail "#$PROGRAM_NAME: unrecognized option found. See '#$PROGRAM_NAME --help' for the available options."
end
SERVICES = {
  :atnd => {
    :host => 'atnd.org',
    :member_sel => '.member_name>li>a',
    :tw_id_sel => "//div[@id='user_info']/dl/dt[.='Twitter ID']/../dd/a",
  }
}


evt_uri = ARGV[0]
evt_id = ARGV[0]

service = opts[:evt_service]
opts[:list_name] ||= service.to_s + evt_id

HREF = 'href'
agent = Mechanize.new
member_sel = SERVICES[service][:member_sel]
tw_id_sel = SERVICES[service][:tw_id_sel]
evt_page = agent.get evt_uri
evt_page.search( member_sel ).map{|a|
  p agent.get(a[HREF]).at( tw_id_sel ).inner_text
}
